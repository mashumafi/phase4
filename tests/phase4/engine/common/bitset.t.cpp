#include <phase4/engine/common/bitset.h>

#include <doctest/doctest.h>

#include <sstream>

TEST_CASE("Bitset getLsb") {
	using namespace phase4::engine::common;

	CHECK(Bitset(0b00101).getLsb() == Bitset(0b001));
	CHECK(Bitset(0b10100).getLsb() == 0b100);
	CHECK(Bitset(0b10100000'00000000'00000000'00000000'00000000'00000000'00000000'00000000).getLsb() == 0b00100000'00000000'00000000'00000000'00000000'00000000'00000000'00000000);
}

TEST_CASE("Bitset popLsb") {
	using namespace phase4::engine::common;

	CHECK(Bitset(0b00101).popLsb() == Bitset(0b00100));
	CHECK(Bitset(0b10100).popLsb() == 0b10000);

	CHECK(Bitset(0b10100000'00000000'00000000'00000000'00000000'00000000'00000000'00000000).popLsb() == 0b10000000'00000000'00000000'00000000'00000000'00000000'00000000'00000000);
	CHECK(Bitset(0b00000101'00000000'00000000'00000000'00000000'00000000'00000000'00000000).popLsb() == 0b00000101'00000000'00000000'00000000'00000000'00000000'00000000'00000000);
}

TEST_CASE("Bitset count") {
	using namespace phase4::engine::common;

	CHECK(Bitset(0b00101).fastCount() == 2);
	CHECK(Bitset(0b10100).fastCount() == 2);
	CHECK(Bitset(0b10100000'00000000'00000000'00000000'00000000'00000000'00000000'00000000).fastCount() == 2);

	CHECK(Bitset(0b00101).count() == 2);
	CHECK(Bitset(0b10100).count() == 2);
	CHECK(Bitset(0b10100000'00000000'00000000'00000000'00000000'00000000'00000000'00000000).count() == 2);
}

TEST_CASE("Bitset bitScan") {
	using namespace phase4::engine::common;

	CHECK(Bitset(0b00101).fastBitScan() == 0);
	CHECK(Bitset((0b10100)).fastBitScan() == 2);
	CHECK(Bitset(0b10100000'00000000'00000000'00000000'00000000'00000000'00000000'00000000).fastBitScan() == 61);
	CHECK(Bitset(0b10000000'00000000'00000000'00000000'00000000'00000000'00000000'00000000).fastBitScan() == 63);

	CHECK(Bitset(0b00101).bitScan() == 0);
	CHECK(Bitset((0b10100)).bitScan() == 2);
	CHECK(Bitset(0b10100000'00000000'00000000'00000000'00000000'00000000'00000000'00000000).bitScan() == 61);
	CHECK(Bitset(0b10000000'00000000'00000000'00000000'00000000'00000000'00000000'00000000).bitScan() == 63);
}

TEST_CASE("Bitset output") {
	using namespace phase4::engine::common;

	Bitset bs = 0b1000000000000100000100000001000000000000000000000000000000000101;
	std::stringstream ss;
	ss << bs;
	CHECK(ss.str() == "1000000000000100000100000001000000000000000000000000000000000101");
}
